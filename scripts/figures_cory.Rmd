---
title: "Cory chatbot test figures"
author: "Simon van Baal"
date: "17/03/2022"
output: html_document
---

```{r setup}

# Please run this script after 'analysis_cory.Rmd'.

library(ggplot2)
library(ggpubr)
library(kableExtra)

```

# Tables
```{r Tables}

eligibility %>%
  group_by(Childhood, Sex, Essential) %>%
  summarise(Number_of_Users = n(),
            Age = round(mean(as.numeric(Age)), 1)) %>%
  write.csv("Eligibility Table.csv")

preTestData <-
  preTestData %>%
  mutate(NationalityGroup = factor(
    ifelse(
      Nationality != "Australia" &
        Nationality != "Viet Nam",
      "Other",
      Nationality
    ),
    levels = c("Australia", "Viet Nam", "Other")
  ))

preTestData %>%
  group_by(NationalityGroup) %>%
  summarise(
    Sample_Size = n() / 15,
    Intention_to_Self_Isolate = mean(Intention),
    Perceived_Effectiveness_of_Lockdown = mean(Effectiveness_Rank),
    Concern_about_COVID = mean(Concern_Rank),
    Importance_of_Testing = mean(Test)
  )

df <- read_csv("Eligibility Table.csv")
colnames(df) <- c("Country", rep(c("Age", "N"), times = 4))

# df %>%
#   kable() %>%
#   kable_styling(bootstrap_options = c("striped", "hover", "responsive", "bordered"), 
#                 full_width = F, 
#                 font_size = 14) %>%
#   column_spec(1:9, color = "black") %>%
#   add_header_above(c(" " = 1, "Female" = 2, "Male" = 2, "Female" = 2, "Male" = 2)) %>%
#   add_header_above(c(" " = 1, "Yes" = 4, "No" = 4)) %>%
#   add_header_above(c(" " = 1, "Essential Worker" = 8)) %>%
#   save_kable(file = "DemoTable.png")



```

# Figures

## Figures of Chatbot Evaluation

```{r Chatbot Evaluation}

# #================================================================================== Assessment of metrics
# DCBIavg <- 
#   postTestData %>% 
#          summarise(Interest_mean = mean(Interest),
#                    Interest_sd = sd(Interest),
#                    Intrigue_mean = mean(Intrigue),
#                    Intrigue_sd = sd(Intrigue),
#                    Focus_mean = mean(Focus),
#                    Focus_sd = sd(Focus),
#                    Inattention_mean = mean(Inattention),
#                    Inattention_sd = sd(Inattention),
#                    Distraction_mean = mean(Distraction),
#                    Distraction_sd = sd(Distraction),
#                    Enjoyment_mean = mean(Enjoyment),
#                    Enjoyment_sd = sd(Enjoyment),
#                    Annoyance_mean = mean(Annoyance),
#                    Annoyance_sd = sd(Annoyance),
#                    Pleasure_mean = mean(Pleasure),
#                    Pleasure_sd = sd(Pleasure),
#                    Learning_mean = mean(Learning),
#                    Learning_sd = sd(Learning)) %>%
#   pivot_longer(Interest_mean:Learning_sd, names_to = c("Metric", "Type"),
#                names_sep = "_",
#                values_to = c("Response")) %>%
#   pivot_wider(id_cols = "Metric", 
#               names_from = "Type", 
#               values_from = "Response")
# 
# ## DCBI plot
# 
# ggplot(DCBIavg,
#        aes(x = reorder(Metric, mean), y = mean, col = mean)) +
#   geom_point() +
#   geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd),
#                 width = .2) +
#   labs(y = "Likert Scale Response", x = "Metric",
#        col = "Response") +
#   scale_y_continuous(breaks=seq(1,7,1), limits = c(.94,7.01)) +
#   scale_colour_viridis_c(begin = .1, end = .65) +
#   theme_light() +
#   ggsave("DCBIplot.png", height = 4, width = 6)
# 
# ##
# 


```

## Figures of Testing Attitudes

```{r Figure prep}

# The palette with black:
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
cbbPaletteBoxPlots <- c("#E69F00","#56B4E9","#000000")
## Plot dimensions
w = 6
h = 4

```

```{r Testing likelihood figures}

# #========================================= Cory's internal data figures
# 
# ggplot(corySummary %>% 
#          filter(!is.na(ExponentialSpreadGuess)) %>% ungroup() %>%
#          mutate(ExponentialSpreadGuess = as.factor(ExponentialSpreadGuess)), 
#        aes(x = ExponentialSpreadGuess, y = Count, fill = testingLikelihoodSpread)) +
#   geom_bar(position="stack", stat="identity") +
#   theme_light()
# 
# ggplot(corySummary %>%
#          filter(!is.na(EmpathyInput)) %>% 
#          ungroup() %>%
#          mutate(`Testing Likelihood` = factor(testingLikelihoodEmpathy, levels = c("Very Likely", "I don't know", "Very Unlikely"))),
#        aes(x = EmpathyInput, y = Count, fill = `Testing Likelihood`)) +
#   geom_bar(position="stack", stat="identity") +
#   labs(x = "Do you know someone who could be vulnerable?") +
#   theme_light()
# 
# ggplot(corySummary, aes(x = Condition, y = Count, fill = testingLikelihood)) +
#          geom_bar(stat = "identity", position = "fill", width = .5) +
#   labs(y = "Proportion of Choices") +
#   scale_fill_manual(name = "Likelihood to get Tested", values = cbbPaletteBoxPlots) +
#   theme_light() +
#   theme(legend.position = "bottom")

```


```{r Testing importance attitudes figures}



```


## Figures of Attitudes toward Leaving Home

```{r Figures}


# #================================================================================= Density plots for attitudes
# 
 surveyData <- 
   surveyData %>%
   mutate(TimepointNumeric = ifelse(Timepoint == "Pre-Test",0,1))

plotHighRiskAttitude <-
  ggplot(surveyData %>%
           filter(Risk == "High"),
         aes(x = Attitude, fill = Timepoint)) +
  geom_density(alpha = .4) +
  geom_boxplot(
    aes(x = Attitude, 
        y = TimepointNumeric * .0015 + 0.0315),
    alpha = .4,
    colour = "black",
    notch = F,
    coef = 1,
    width = .001,
  ) +
  labs(title = "High Risk", 
       x = "Certainty", 
       y = "Frequency") +
  scale_fill_viridis_d(begin = .2, end = .7) +
  theme_light() +
  theme(axis.title.x = element_blank()) +
  guides(fill = guide_legend(reverse = T))

plotLowRiskAttitude <-
  ggplot(surveyData %>%
           filter(Risk == "Low"),
         aes(x = Attitude, fill = Timepoint)) +
  geom_density(alpha = .4) +
  geom_boxplot(aes(x = Attitude, 
                   y = TimepointNumeric * .0015 + 0.0315),
               alpha = .4, 
               colour = "black", 
               notch = F, 
               coef = 1,
               width = .001) +
  labs(title = "Low Risk", 
       x = "Certainty", 
       y = "Frequency") +
  scale_fill_viridis_d(begin = .2, end = .7) +
  theme_light() +
  theme(axis.title = element_blank()) +
  guides(fill = guide_legend(reverse = T)) 

plotMinimalRiskAttitude <-
  ggplot(surveyData %>%
           filter(Risk == "Minimal"),
         aes(x = Attitude, fill = Timepoint)) +
  geom_density(alpha = .4) +
  geom_boxplot(aes(x = Attitude, y = TimepointNumeric * .0015 + 0.0315),
               alpha = .4, 
               colour = "black", 
               notch = F, 
               coef = 1,
               width = .001) +
  labs(title = "Minimal Risk",
       x = "Certainty", 
       y = "Frequency",
       fill = "Timepoint") +
  scale_fill_viridis_d(begin = .2, end = .7) +
  theme_light() +
  theme(axis.title = element_blank()) +
  guides(fill = guide_legend(reverse = T))
 

attitudePlots <- 
  ggarrange(plotHighRiskAttitude,
          plotLowRiskAttitude,
          plotMinimalRiskAttitude,
          ncol = 3, nrow = 1,
          common.legend = T,
          legend = "top")

annotate_figure(attitudePlots, 
                bottom = text_grob("Permissiveness of Going Out"))
ggsave(here("output/figures/plot_certainty-pre-post.png"),
         height = 4, width = 8)

```

