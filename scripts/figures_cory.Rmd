---
title: "Cory chatbot test figures"
author: "Simon van Baal"
date: "17/03/2022"
output: html_document
---

```{r setup}

# Please run this script after 'analysis_cory.Rmd'.

library(ggplot2)
library(ggpubr)
library(kableExtra)

```

```{r load data}

postTestData <-
  read_csv(here("output/data/clean_post-test_cory.csv"))

```


# Tables
```{r Tables}

eligibility %>%
  group_by(Childhood, Sex, Essential) %>%
  summarise(Number_of_Users = n(),
            Age = round(mean(as.numeric(Age)), 1)) %>%
  write.csv("Eligibility Table.csv")

preTestData <-
  preTestData %>%
  mutate(NationalityGroup = factor(
    ifelse(
      Nationality != "Australia" &
        Nationality != "Viet Nam",
      "Other",
      Nationality
    ),
    levels = c("Australia", "Viet Nam", "Other")
  ))

preTestData %>%
  group_by(NationalityGroup) %>%
  summarise(
    Sample_Size = n() / 15,
    Intention_to_Self_Isolate = mean(Intention),
    Perceived_Effectiveness_of_Lockdown = mean(Effectiveness_Rank),
    Concern_about_COVID = mean(Concern_Rank),
    Importance_of_Testing = mean(Test)
  )

df <- read_csv(here("output/figures/table_demographics.csv"))
colnames(df) <- c("Country", rep(c("Age", "N"), times = 4))

# df %>%
#   kable() %>%
#   kable_styling(bootstrap_options = c("striped", "hover", "responsive", "bordered"), 
#                 full_width = F, 
#                 font_size = 14) %>%
#   column_spec(1:9, color = "black") %>%
#   add_header_above(c(" " = 1, "Female" = 2, "Male" = 2, "Female" = 2, "Male" = 2)) %>%
#   add_header_above(c(" " = 1, "Yes" = 4, "No" = 4)) %>%
#   add_header_above(c(" " = 1, "Essential Worker" = 8)) %>%
#   save_kable(file = "DemoTable.png")



```

# Figures

## Figures of Chatbot Evaluation

```{r Chatbot Evaluation}

# #================================================================================== Assessment of metrics
DCBIavg <-
  postTestData %>%
  summarise(
    Interest_mean = mean(Interest),
    Interest_sd = sd(Interest),
    Intrigue_mean = mean(Intrigue),
    Intrigue_sd = sd(Intrigue),
    Focus_mean = mean(Focus),
    Focus_sd = sd(Focus),
    Inattention_mean = mean(Inattention),
    Inattention_sd = sd(Inattention),
    Distraction_mean = mean(Distraction),
    Distraction_sd = sd(Distraction),
    Enjoyment_mean = mean(Enjoyment),
    Enjoyment_sd = sd(Enjoyment),
    Annoyance_mean = mean(Annoyance),
    Annoyance_sd = sd(Annoyance),
    Pleasure_mean = mean(Pleasure),
    Pleasure_sd = sd(Pleasure),
    Learning_mean = mean(Learning),
    Learning_sd = sd(Learning)
  ) %>%
  pivot_longer(
    Interest_mean:Learning_sd,
    names_to = c("Metric", "Type"),
    names_sep = "_",
    values_to = c("Response")
  ) %>%
  pivot_wider(id_cols = "Metric",
              names_from = "Type",
              values_from = "Response")

## DCBI plot

plotDCBI <- 
  ggplot(DCBIavg,
       aes(
         x = reorder(Metric, desc(mean)),
         y = mean,
         col = mean
       )) +
  geom_point() +
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd),
                width = .2) +
  labs(y = "Likert Scale Response", x = "Metric",
       col = "Response") +
  scale_y_continuous(breaks = seq(1, 7, 1), limits = c(.94, 7.01)) +
  scale_colour_viridis_c(begin = .1, end = .65) +
  theme_light() +
  theme(legend.position = "none")
ggsave(
    here("output/figures/plot_experience_cory.png"),
    height = 4,
    width = 6
  )

rm(DCBIavg)

```

## Figures of Testing Attitudes



```{r Testing likelihood figures}

# Testing likelihood figure

plotTestingLikelihood <-
  ggplot(
    chatbotData %>%
      filter(!is.na(testingLikelihood)) %>%
      mutate(
        testingLikelihood = factor(
          ifelse(
            testingLikelihood == "Very Likely",
            "Very Likely",
            ifelse(testingLikelihood == "I don't know",
                   "Unsure",
                   "Very Unlikely")
          ),
          levels = c("Very Likely",
                     "Unsure",
                     "Very Unlikely")
        ),
        Condition = factor(
          Condition,
          levels = c("Exponential Growth",
                     "Compassion",
                     "Control")
        )
      ),
    aes(group = Condition,
        x = testingLikelihood)
  ) +
  geom_bar(aes(y = ..prop.., fill = Condition),
           width = .5,
           position = position_dodge2()) +
  labs(x = "Testing Likelihood",
       y = "Percentage of Answers") +
  theme_light() +
  theme(legend.position = "bottom") +
  scale_fill_viridis_d(begin = .2, end = .8) +
  scale_y_continuous(labels = scales::percent)
ggsave(here("output/figures/plot_test-likelihood.png"),
            width = 6, height = 4)


```


```{r Testing importance attitudes figures}

plotTestImportance <- 
  afex_plot(lmTestImportance, ~Condition,
          mapping = "colour",
          data_geom = geom_violin) +
  geom_hline(aes(yintercept = 0),
             alpha = .5,
             size = .2) +
  labs(y = expression("Positive Change in Perceived Testing Importance " %->% "")) +
  scale_color_viridis_d(begin = .2, end = .65) +
  theme_light() +
  theme(legend.position = "none")

ggsave(here("output/figures/plot_test-importance.png"),
       height = 4, 
       width = 6)

```


## Figures of Attitudes toward Leaving Home

```{r plots for attitudes to leaving home attitudes}
#================================================================================= Density plots for attitudes
 
surveyData <- 
  surveyData %>%
  mutate(TimepointNumeric = ifelse(Timepoint == "Pre-Test",0,1))

plotHighRiskAttitude <-
  ggplot(surveyData %>%
           filter(Risk == "High"),
         aes(x = Attitude, fill = Timepoint)) +
  geom_density(alpha = .4) +
  geom_boxplot(
    aes(x = Attitude, 
        y = TimepointNumeric * .0015 + 0.0315),
    alpha = .4,
    colour = "black",
    notch = F,
    coef = 1,
    width = .001,
  ) +
  labs(title = "High Risk", 
       x = "Certainty", 
       y = "Frequency") +
  scale_fill_viridis_d(begin = .2, end = .7) +
  theme_light() +
  theme(axis.title.x = element_blank()) +
  guides(fill = guide_legend(reverse = T))

plotLowRiskAttitude <-
  ggplot(surveyData %>%
           filter(Risk == "Low"),
         aes(x = Attitude, fill = Timepoint)) +
  geom_density(alpha = .4) +
  geom_boxplot(aes(x = Attitude, 
                   y = TimepointNumeric * .0015 + 0.0315),
               alpha = .4, 
               colour = "black", 
               notch = F, 
               coef = 1,
               width = .001) +
  labs(title = "Low Risk", 
       x = "Certainty", 
       y = "Frequency") +
  scale_fill_viridis_d(begin = .2, end = .7) +
  theme_light() +
  theme(axis.title = element_blank()) +
  guides(fill = guide_legend(reverse = T)) 

plotMinimalRiskAttitude <-
  ggplot(surveyData %>%
           filter(Risk == "Minimal"),
         aes(x = Attitude, fill = Timepoint)) +
  geom_density(alpha = .4) +
  geom_boxplot(aes(x = Attitude, y = TimepointNumeric * .0015 + 0.0315),
               alpha = .4, 
               colour = "black", 
               notch = F, 
               coef = 1,
               width = .001) +
  labs(title = "Minimal Risk",
       x = "Certainty", 
       y = "Frequency",
       fill = "Timepoint") +
  scale_fill_viridis_d(begin = .2, end = .7) +
  theme_light() +
  theme(axis.title = element_blank()) +
  guides(fill = guide_legend(reverse = T))
 

attitudePlots <- 
  ggarrange(plotHighRiskAttitude,
          plotLowRiskAttitude,
          plotMinimalRiskAttitude,
          ncol = 3, nrow = 1,
          common.legend = T,
          legend = "top")

annotate_figure(attitudePlots, 
                bottom = text_grob("Permissiveness of Going Out"))
ggsave(here("output/figures/plot_certainty-pre-post.png"),
         height = 4, width = 8)

```

