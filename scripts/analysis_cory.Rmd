---
title: "Cory analysis"
author: "Simon van Baal"
date: "16/02/2022"
output: html_document
---

```{r setup, include=FALSE}

library(ordinal)
library(ordinalCont)
library(afex)
library(emmeans)
library(onewaytests)

surveyData <- read_csv(here("./output/data/clean_surveys_cory.csv"))
chatbotData <- read_csv(here("./output/data/clean_chatbot_cory.csv"))
```


```{r Descriptive statistics}

surveyData %>%
  group_by(Sex) %>%
  summarise(Mean_Age = mean(as.numeric(Age), na.rm = T),
            Min_Age = min(as.numeric(Age), na.rm = T),
            Max_Age = max(as.numeric(Age), na.rm = T),
            n = n()/30)

surveyData %>%
  group_by(Nationality) %>%
  summarise(n = n())

TestJudgments <-
  surveyData %>%
  group_by(ParticipantID, Study_Type, Condition) %>%
  summarise(TestImportance = mean(TestImportance)) 

surveyData %>%
  group_by(Study_Type, Condition) %>%
  summarise(TestImportance = mean(TestImportance)) %>%
  arrange(Condition, desc(Study_Type))

chatbotData %>%
  group_by(Condition, testingLikelihood) %>%
  summarise(n = n())


# surveyData %>% 
#   summarise(Interest = mean(Interest),
#                            Intrigue = mean(Intrigue),
#                            Focus = mean(Focus),
#                            Inattention = mean(Inattention),
#                            Distraction = mean(Distraction),
#                            Enjoyment = mean(Enjoyment),
#                            Annoyance = mean(Annoyance),
#                            Pleasure = mean(Pleasure),
#                            Learning = mean(Learning)) %>%
#   pivot_longer(Interest:Learning, names_to = "Metric", values_to="Response")



```
```{r Analysis prep}
# Ordering factor levels and scaling the age variable.
chatbotData <-
  chatbotData %>%
  mutate(
    testingLikelihood = factor(
      testingLikelihood,
      levels = c("Very Unlikely",
                 "I don't know",
                 "Very Likely")
    ),
    testingLikNum = ifelse(
      testingLikelihood ==
        "Very Unlikely",
      1,
      ifelse(
        testingLikelihood ==
          "I don't know",
        2,
        ifelse(testingLikelihood ==
                 "Very Likely", 3, NA)
      )
    ),
    Condition = factor(
      Condition,
      levels = c("Control",
                 "Compassion",
                 "Exponential Growth")
    ),
    Age = scale(Age, center = T, scale = T),
    Sex = factor(Sex)
  )


# Set contrasts for factor to sum contrasts
contrasts(chatbotData$Condition) <- contr.sum(3)
contrasts(chatbotData$Sex) <- contr.sum(2)

clm.control(relTol = 1e-9)

```

```{r Analysis}

wilcox.test(x = chatbotData$testingLikNum[chatbotData$Condition=="Exponential Growth"],
            y = chatbotData$testingLikNum[chatbotData$Condition=="Control"])

wilcox.test(x = chatbotData$testingLikNum[chatbotData$Condition=="Compassion"],
            y = chatbotData$testingLikNum[chatbotData$Condition=="Control"])


# Run cumulative link model

clmTestingLikelihood <- 
  clm(testingLikelihood ~ 
        Condition,
       data = chatbotData %>% 
        filter(!is.na(testingLikelihood)),
      link = "logit")
# Hessian singular -> collapse categories (done above).

drop1(clmTestingLikelihood, test = "Chi")

# Run binomial model
glmTestingLikelihood <- 
  glm(testingLikelihoodBinary ~ 
        Condition,
       data = chatbotData %>% 
        filter(!is.na(testingLikelihood)),
       family = "binomial")

emmeansClmTestingLikelihood <- 
  emmeans(clmTestingLikelihood, specs = "Condition", mode = "mean.class")
pairs(emmeansClmTestingLikelihood, reverse = T)

emmeansGlmTestingLikelihood <- 
  emmeans(glmTestingLikelihood, ~Condition)
pairs(emmeansGlmTestingLikelihood, reverse = T)

```

```{r Certainty testing}

certaintyData <- 
  surveyData %>%
  mutate(AbsCertainty = abs(Attitude))

certaintyLMM <- 
  mixed(AbsCertainty ~ 
          Risk*Timepoint + 
          (1|ID),
         certaintyData)

emmeansCertainty <- 
  emmeans(certaintyLMM, ~ Study_Type|Risk)
pairs(emmeansCertainty, reverse = T)

# Equal variances testing

HighRisksurveyData <- 
  surveyData %>% filter(Risk == "High_Risk")
HighRiskEqVariancesTest <- 
  levene.test(HighRisksurveyData$Attitude, HighRisksurveyData$Study_Type)

LowRisksurveyData <- 
  surveyData %>% filter(Risk == "Low_Risk")
LowRiskEqVariancesTest <- 
  levene.test(LowRisksurveyData$Attitude, LowRisksurveyData$Study_Type)

MinimalRisksurveyData <- 
  surveyData %>% filter(Risk == "Minimal_Risk")
MinimalRiskEqVariancesTest <- 
  levene.test(MinimalRisksurveyData$Attitude, MinimalRisksurveyData$Study_Type)

```

```{r Testing importance}

# Testing importance of getting tested before and after Cory.
TestImportanceData <- 
  surveyData %>% 
  group_by(ID, Study_Type, Condition) %>%
  summarise(TestImportance = mean(Test)) %>%
  pivot_wider(id_cols = c("ID", "Condition"),
              names_from = "Study_Type",
              values_from = "TestImportance") %>%
  mutate(TestImportanceDifference = `Post-Test`-`Pre-Test`,
         Condition = factor(Condition, 
                            levels = c("Empathy", 
                                       "Exponential Growth", 
                                       "Control")))

contrasts(TestImportanceData$Condition) <- contr.sum(3)

LMMTestImportance <- 
  lm(TestImportanceDifference ~ Condition, 
        data = TestImportanceData)

EmmeansTestImportance <- 
  emmeans(LMMTestImportance, ~ Condition)

afex_plot(LMMTestImportance, ~Condition,
          mapping = "colour",
          data_geom = geom_violin) +
  labs(y = "Difference in Perceived Importance of Testing") +
  scale_color_viridis_d(begin = .2, end = .65) +
  theme_light()

```
